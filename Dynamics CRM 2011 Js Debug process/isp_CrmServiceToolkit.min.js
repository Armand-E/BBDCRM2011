CrmServiceToolkit=function(){var _dateTimeExpr=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})[\.\d{3}]?([-+]\d{2}):(\d{2})$/,_numberExpr=/^[-+]?\d*\.?\d*$/,_integerExpr=/^[0-9]\d*$/;var _doRequest=function(soapBody,requestType,async,internalCallback){async=async||false;var soapXml=["<soap:Envelope xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema'>",GenerateAuthenticationHeader(),"<soap:Body>","<",requestType," xmlns='http://schemas.microsoft.com/crm/2007/WebServices'>",soapBody,"</",requestType,">","</soap:Body>","</soap:Envelope>"].join("");var xmlhttp=new ActiveXObject("Msxml2.XMLHTTP");xmlhttp.open("POST","/MSCRMServices/2007/crmservice.asmx",async);xmlhttp.setRequestHeader("Content-Type","text/xml; charset=utf-8");xmlhttp.setRequestHeader("SOAPAction","http://schemas.microsoft.com/crm/2007/WebServices/"+requestType);xmlhttp.send(soapXml);if(async){xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){if(xmlhttp.status==200){internalCallback(_processResponse(xmlhttp.responseXML,xmlhttp.responseText))}else{throw new Error("HTTP-Requests ERROR: "+xmlhttp.statusText)}}}}else{var result=_processResponse(xmlhttp.responseXML);return !!internalCallback?internalCallback(result):result}};var _processResponse=function(responseXml,responseText){if(responseXml===null||responseXml.xml===null||responseXml.xml===""){if(responseText!==null&&responseText!==""){throw new Error(responseText)}else{throw new Error("No response received from the server. ")}}var error=responseXml.selectSingleNode("//error");var faultString=responseXml.selectSingleNode("//faultstring");if(error!==null||faultString!==null){throw new Error(error!==null?responseXml.selectSingleNode("//description").nodeTypedValue:faultString.text)}var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async=false;xmlDoc.loadXML(responseXml.xml);return xmlDoc};var _fetch=function(fetchXml,callback){var msgBody="<fetchXml>"+_HtmlEncode(fetchXml)+"</fetchXml>";var async=!!callback;return _doRequest(msgBody,"Fetch",!!callback,function(resultXml){var fetchResult=resultXml.selectSingleNode("//FetchResult");resultXml.loadXML(fetchResult.childNodes[0].nodeValue);var resultNodes=resultXml.selectNodes("/resultset/result");var results=[];for(var i=0;i<resultNodes.length;i++){var entity=new _businessEntity();entity.deserialize(resultNodes[i]);results[i]=entity}if(!async){return results}else{callback(results)}})};var _retrieve=function(entityName,id,columnSet,callback){var attributes="";if(columnSet!==undefined){for(var i=0;i<columnSet.length;i++){attributes+="<q1:Attribute>"+columnSet[i]+"</q1:Attribute>"}}var msgBody=["<entityName>",entityName,"</entityName>","<id>",id,"</id>","<columnSet xmlns:q1='http://schemas.microsoft.com/crm/2006/Query' xsi:type='q1:ColumnSet'>","<q1:Attributes>",attributes,"</q1:Attributes>","</columnSet>"].join("");var async=!!callback;return _doRequest(msgBody,"Retrieve",!!callback,function(resultXml){var retrieveResult=resultXml.selectSingleNode("//RetrieveResult");var entity=new _businessEntity();entity.deserialize(retrieveResult);if(!async){return entity}else{callback(entity)}})};var _retrieveMultiple=function(query,callback){var msgBody=["<Request xsi:type='RetrieveMultipleRequest' ReturnDynamicEntities='false'>","<Query xmlns:q1='http://schemas.microsoft.com/crm/2006/Query' xsi:type='q1:QueryExpression'>",query,"</Query>","</Request>"].join("");var async=!!callback;return _doRequest(msgBody,"Execute",async,function(resultXml){var resultNodes=resultXml.selectNodes("//BusinessEntityCollection/BusinessEntities/BusinessEntity");var results=[];for(var i=0;i<resultNodes.length;i++){var entity=new _businessEntity();entity.deserialize(resultNodes[i]);results[i]=entity}if(!async){return results}else{callback(results)}})};var _execute=function(request,callback){var async=!!callback;return _doRequest(request,"Execute",async,function(resultXml){if(!async){return resultXml}else{callback(resultXml)}})};var _create=function(businessEntity,callback){var request=businessEntity.serialize();var async=!!callback;return _doRequest(request,"Create",async,function(resultXml){var response=resultXml.selectSingleNode("//CreateResponse/CreateResult");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _update=function(businessEntity,callback){var request=businessEntity.serialize();var async=!!callback;return _doRequest(request,"Update",async,function(resultXml){var response=resultXml.selectSingleNode("//UpdateResponse");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _delete=function(entityName,id,callback){var request=["<entityName>",entityName,"</entityName>","<id>",id,"</id>"].join("");var async=!!callback;return _doRequest(request,"Delete",async,function(resultXml){var response=resultXml.selectSingleNode("//DeleteResponse");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _joinArray=function(prefix,array,suffix){var output=[];for(var i=0;i<array.length;i++){if(array[i]!=""&&array[i]!=undefined){output.push(prefix,array[i],suffix)}}return output.join("")};var _joinConditionPair=function(attributes,values){var output=[];for(var i=0;i<attributes.length;i++){if(attributes[i]!=""){output.push("<condition attribute='",attributes[i],"' operator='eq' value='",values[i],"' />")}}return output.join("")};var _isArray=function(input){return input.constructor.toString().indexOf("Array")!=-1};var _queryByAttribute=function(queryOptions,callback){var entityName=queryOptions.entityName;var attributes=queryOptions.attributes;var values=queryOptions.values;var columnSet=queryOptions.columnSet;var orderby=queryOptions.orderby||"";attributes=_isArray(attributes)?attributes:[attributes];values=_isArray(values)?values:[values];orderby=(!!orderby&&_isArray(orderby))?orderby:[orderby];columnSet=(!!columnSet&&_isArray(columnSet))?columnSet:[columnSet];for(var i=0;i<values.length;i++){values[i]=_encodeValue(values[i])}var xml=["<fetch mapping='logical'>","   <entity name='",entityName,"'>",_joinArray("<attribute name='",columnSet,"' />"),_joinArray("<order attribute='",orderby,"' />"),"      <filter>",_joinConditionPair(attributes,values),"      </filter>","   </entity>","</fetch>"].join("");return _fetch(xml,callback)};var _setState=function(entityName,id,stateCode,statusCode,callback){var request=["<Request xsi:type='SetStateDynamicEntityRequest'>","<Entity>","<Name xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entityName,"</Name>","<Id xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",id,"</Id>","</Entity>","<State>",stateCode,"</State>","<Status>",statusCode,"</Status>","</Request>"].join("");var async=!!callback;return _doRequest(request,"Execute",async,function(resultXml){var response=resultXml.selectSingleNode("//ExecuteResponse/Response");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _associate=function(relationshipName,entity1Name,entity1Id,entity2Name,entity2Id,callback){var request=["<Request xsi:type='AssociateEntitiesRequest'>","<Moniker1>","<Id xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity1Id,"</Id>","<Name xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity1Name,"</Name>","</Moniker1>","<Moniker2>","<Id xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity2Id,"</Id>","<Name xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity2Name,"</Name>","</Moniker2>","<RelationshipName>",relationshipName,"</RelationshipName>","</Request>"].join("");var async=!!callback;return _doRequest(request,"Execute",async,function(resultXml){var response=resultXml.selectSingleNode("//ExecuteResponse/Response");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _disassociate=function(relationshipName,entity1Name,entity1Id,entity2Name,entity2Id,callback){var request=["<Request xsi:type='DisassociateEntitiesRequest'>","<Moniker1>","<Id xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity1Id,"</Id>","<Name xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity1Name,"</Name>","</Moniker1>","<Moniker2>","<Id xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity2Id,"</Id>","<Name xmlns='http://schemas.microsoft.com/crm/2006/CoreTypes'>",entity2Name,"</Name>","</Moniker2>","<RelationshipName>",relationshipName,"</RelationshipName>","</Request>"].join("");var async=!!callback;return _doRequest(request,"Execute",async,function(resultXml){var response=resultXml.selectSingleNode("//ExecuteResponse/Response");var result=CrmEncodeDecode.CrmXmlDecode(response.text);if(!async){return result}else{callback(result)}})};var _getCurrentUserRoles=function(){var xml=["<fetch mapping='logical'>","   <entity name='role'>","      <attribute name='name' />","      <link-entity name='systemuserroles' from='roleid' to='roleid' link-type='inner'>","         <filter>","            <condition attribute='systemuserid' operator='eq-userid' />","         </filter>","         <link-entity name='systemuser' from='systemuserid' to='systemuserid' link-type='inner' />","      </link-entity>","   </entity>","</fetch>"].join("");var fetchResult=_fetch(xml);var roles=[];if(fetchResult!==null){for(var i=0;i<fetchResult.length;i++){roles[i]=fetchResult[i].getValue("name")}}return roles};var _getCurrentUserId=function(){var request="<Request xsi:type='WhoAmIRequest' />";var xmlDoc=_doRequest(request,"Execute");return xmlDoc.getElementsByTagName("UserId")[0].childNodes[0].nodeValue};var _isCurrentUserInRole=function(){var roles=_getCurrentUserRoles();for(var i=0;i<roles.length;i++){for(var j=0;j<arguments.length;j++){if(roles[i]===arguments[j]){return true}}}return false};var _padNumber=function(s,len){len=len||2;s=""+s;while(s.length<len){s="0"+s}return s};var _getDatePart=function(s){s=s.replace(/^0+(.)$/,"$1");return parseInt(s)};var _parseDate=function(s){if(s==null||!s.match(_dateTimeExpr)){return null}var dateParts=_dateTimeExpr.exec(s);return new Date(_getDatePart(dateParts[1]),_getDatePart(dateParts[2])-1,_getDatePart(dateParts[3]),_getDatePart(dateParts[4]),_getDatePart(dateParts[5]),_getDatePart(dateParts[6]))};var _encodeDate=function(dateTime){return dateTime.getFullYear()+"-"+_padNumber(dateTime.getMonth()+1)+"-"+_padNumber(dateTime.getDate())+"T"+_padNumber(dateTime.getHours())+":"+_padNumber(dateTime.getMinutes())+":"+_padNumber(dateTime.getSeconds())};var _parseResultXmlNode=function(fieldNode){var field={};for(var k=0;k<fieldNode.attributes.length;k++){field[fieldNode.attributes[k].nodeName]=CrmEncodeDecode.CrmXmlDecode(fieldNode.attributes[k].nodeValue)}var nodeText=CrmEncodeDecode.CrmXmlDecode(fieldNode.text);if(fieldNode.attributes.length===1&&fieldNode.getAttribute("formattedvalue")!==null&&nodeText.match(_numberExpr)){if(!nodeText.indexOf(".")){field["$value"]=parseInt(nodeText)}else{field["$value"]=parseFloat(nodeText)}}else{if(fieldNode.attributes.length===2&&fieldNode.getAttribute("formattedvalue")!==null&&fieldNode.getAttribute("name")!==null&&nodeText.match(_integerExpr)){field["$value"]=parseInt(nodeText)}else{if(fieldNode.attributes.length===1&&fieldNode.getAttribute("name")!==null&&nodeText.match(_integerExpr)){field["$value"]=parseInt(nodeText)}else{if(fieldNode.attributes.length===2&&fieldNode.getAttribute("date")!==null&&fieldNode.getAttribute("time")!==null&&nodeText.match(_dateTimeExpr)){field["$value"]=_parseDate(nodeText)}else{field["$value"]=nodeText}}}}return field};var _encodeValue=function(value){return(typeof value==="object"&&value.getTime)?_encodeDate(value):CrmEncodeDecode.CrmXmlEncode(value)};var _businessEntity=function(entityName){this.name=entityName;this.attributes={}};_businessEntity.prototype={getValue:function(field,attribute){if(this===null||!this.attributes.hasOwnProperty(field)){return null}return(attribute===undefined)?this.attributes[field]["$value"]:this.attributes[field][attribute]},getValueAsBoolean:function(field){if(this===null||!this.attributes.hasOwnProperty(field)){return null}return(this.attributes[field]["$value"]==1)},getValueAsLookup:function(field,typename){if(this===null||!this.attributes.hasOwnProperty(field)){return null}if(!this.attributes[field].hasOwnProperty("name")){throw new Error("'"+field+"' does not seem to be a CRM lookup field. ")}return[{id:this.attributes[field]["$value"],typename:typename,name:this.attributes[field]["name"]}]},serialize:function(){var xml=['<entity xsi:type="',this.name,'">'];for(var attributeName in this.attributes){var attribute=this.attributes[attributeName];if(attribute===null||attribute.value===null){xml.push("<",attributeName,' IsNull="true" />')}else{var value=(attribute.hasOwnProperty("$value"))?attribute["$value"]:attribute;var encodedValue=_encodeValue(value);var type=(!attribute.type)?"":' type="'+CrmEncodeDecode.CrmXmlEncode(attribute.type)+'"';xml.push("<",attributeName,type,">",encodedValue,"</",attributeName,">")}}xml.push("</entity>");return xml.join("")},deserialize:function(resultNode){var resultNodes=resultNode.childNodes;for(var i=0;i<resultNodes.length;i++){var fieldNode=resultNodes[i];this.attributes[fieldNode.baseName]=_parseResultXmlNode(fieldNode)}}};return{BusinessEntity:_businessEntity,Retrieve:_retrieve,RetrieveMultiple:_retrieveMultiple,Fetch:_fetch,Execute:_execute,Create:_create,Update:_update,Delete:_delete,queryByAttribute:_queryByAttribute,setState:_setState,associate:_associate,disassociate:_disassociate,isCurrentUserInRole:_isCurrentUserInRole,getCurrentUserRoles:_getCurrentUserRoles,getCurrentUserId:_getCurrentUserId,parseDate:_parseDate,encodeDate:_encodeDate}}();
